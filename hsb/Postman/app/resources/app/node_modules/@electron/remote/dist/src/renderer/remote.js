"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.createFunctionWithReturnValue=exports.getGlobal=exports.getCurrentWebContents=exports.getCurrentWindow=exports.getBuiltin=void 0;let callbacks_registry_1=require("./callbacks-registry"),type_utils_1=require("../common/type-utils"),electron_1=require("electron"),module_names_1=require("../common/module-names"),get_electron_binding_1=require("../common/get-electron-binding"),{Promise:e}=global,callbacksRegistry=new callbacks_registry_1.CallbacksRegistry,remoteObjectCache=new Map,finalizationRegistry=new FinalizationRegistry(e=>{let t=remoteObjectCache.get(e);void 0!==t&&void 0===t.deref()&&(remoteObjectCache.delete(e),electron_1.ipcRenderer.send("REMOTE_BROWSER_DEREFERENCE",contextId,e,0))}),electronIds=new WeakMap,isReturnValue=new WeakSet;function getCachedRemoteObject(e){let t=remoteObjectCache.get(e);if(void 0!==t){let e=t.deref();if(void 0!==e)return e}}function setCachedRemoteObject(e,t){let r=new WeakRef(t);return remoteObjectCache.set(e,r),finalizationRegistry.register(t,e),t}function getContextId(){let e=get_electron_binding_1.getElectronBinding("v8_util");if(e)return e.getHiddenValue(global,"contextId");throw Error("Electron >=v13.0.0-beta.6 required to support sandboxed renderers")}let contextId=process.contextId||getContextId();process.on("exit",()=>{electron_1.ipcRenderer.send("REMOTE_BROWSER_CONTEXT_RELEASE",contextId)});let IS_REMOTE_PROXY=Symbol("is-remote-proxy");function wrapArgs(e,t=new Set){let r=e=>{if(t.has(e))return{type:"value",value:null};if(e&&e.constructor&&"NativeImage"===e.constructor.name)return{type:"nativeimage",value:type_utils_1.serialize(e)};if(Array.isArray(e)){t.add(e);let r={type:"array",value:wrapArgs(e,t)};return t.delete(e),r}if(e instanceof Buffer)return{type:"buffer",value:e};if(type_utils_1.isSerializableObject(e))return{type:"value",value:e};if("object"==typeof e){if(type_utils_1.isPromise(e))return{type:"promise",then:r(function(t,r){e.then(t,r)})};if(electronIds.has(e))return{type:"remote-object",id:electronIds.get(e)};let n={type:"object",name:e.constructor?e.constructor.name:"",members:[]};for(let o in t.add(e),e)n.members.push({name:o,value:r(e[o])});return t.delete(e),n}else if("function"==typeof e&&isReturnValue.has(e))return{type:"function-with-return-value",value:r(e())};else if("function"==typeof e)return{type:"function",id:callbacksRegistry.add(e),location:callbacksRegistry.getLocation(e),length:e.length};else return{type:"value",value:e}};return e.map(r)}function setObjectMembers(e,t,r,n){if(Array.isArray(n))for(let o of n){if(Object.prototype.hasOwnProperty.call(t,o.name))continue;let n={enumerable:o.enumerable};if("method"===o.type){let t=function(...e){let n;return n=this&&this.constructor===t?"REMOTE_BROWSER_MEMBER_CONSTRUCTOR":"REMOTE_BROWSER_MEMBER_CALL",metaToValue(electron_1.ipcRenderer.sendSync(n,contextId,r,o.name,wrapArgs(e)))},i=proxyFunctionProperties(t,r,o.name);n.get=()=>(i.ref=e,i),n.set=e=>(i=e,e),n.configurable=!0}else"get"===o.type&&(n.get=()=>metaToValue(electron_1.ipcRenderer.sendSync("REMOTE_BROWSER_MEMBER_GET",contextId,r,o.name)),o.writable&&(n.set=e=>{let t=wrapArgs([e]),n=electron_1.ipcRenderer.sendSync("REMOTE_BROWSER_MEMBER_SET",contextId,r,o.name,t);return null!=n&&metaToValue(n),e}));Object.defineProperty(t,o.name,n)}}function setObjectPrototype(e,t,r,n){if(null===n)return;let o={};setObjectMembers(e,o,r,n.members),setObjectPrototype(e,o,r,n.proto),Object.setPrototypeOf(t,o)}function proxyFunctionProperties(e,t,r){let n=!1,o=()=>{if(n)return;n=!0;let o=electron_1.ipcRenderer.sendSync("REMOTE_BROWSER_MEMBER_GET",contextId,t,r);setObjectMembers(e,e,o.id,o.members)};return new Proxy(e,{set:(e,t,r)=>("ref"!==t&&o(),e[t]=r,!0),get:(e,t)=>{if(t===IS_REMOTE_PROXY)return!0;Object.prototype.hasOwnProperty.call(e,t)||o();let r=e[t];return"toString"===t&&"function"==typeof r?r.bind(e):r},ownKeys:e=>(o(),Object.getOwnPropertyNames(e)),getOwnPropertyDescriptor:(e,t)=>{let r=Object.getOwnPropertyDescriptor(e,t);return r||(o(),Object.getOwnPropertyDescriptor(e,t))}})}function metaToValue(t){if(!t)return{};if("value"===t.type)return t.value;if("array"===t.type)return t.members.map(e=>metaToValue(e));if("nativeimage"===t.type)return type_utils_1.deserialize(t.value);if("buffer"===t.type)return Buffer.from(t.value.buffer,t.value.byteOffset,t.value.byteLength);if("promise"===t.type)return e.resolve({then:metaToValue(t.then)});else if("error"===t.type)return metaToError(t);else if("exception"===t.type)if("error"===t.value.type)throw metaToError(t.value);else throw Error(`Unexpected value type in exception: ${t.value.type}`);else{let e;if("id"in t){let e=getCachedRemoteObject(t.id);if(void 0!==e)return e}if("function"===t.type){let r=function(...e){let n;return n=this&&this.constructor===r?"REMOTE_BROWSER_CONSTRUCTOR":"REMOTE_BROWSER_FUNCTION_CALL",metaToValue(electron_1.ipcRenderer.sendSync(n,contextId,t.id,wrapArgs(e)))};e=r}else e={};return setObjectMembers(e,e,t.id,t.members),setObjectPrototype(e,e,t.id,t.proto),e.constructor&&e.constructor[IS_REMOTE_PROXY]&&Object.defineProperty(e.constructor,"name",{value:t.name}),electronIds.set(e,t.id),setCachedRemoteObject(t.id,e),e}}function metaToError(e){let t=e.value;for(let{name:r,value:n}of e.members)t[r]=metaToValue(n);return t}function hasSenderId(e){return"number"==typeof e.senderId}function handleMessage(e,t){electron_1.ipcRenderer.on(e,(r,n,o,...i)=>{if(hasSenderId(r)&&0!==r.senderId&&void 0!==r.senderId)return void console.error(`Message ${e} sent by unexpected WebContents (${r.senderId})`);n===contextId?t(o,...i):electron_1.ipcRenderer.send("REMOTE_BROWSER_WRONG_CONTEXT_ERROR",contextId,n,o)})}let enableStacks=process.argv.includes("--enable-api-filtering-logging");function getCurrentStack(){let e={stack:void 0};return enableStacks&&Error.captureStackTrace(e,getCurrentStack),e.stack}function getBuiltin(e){return metaToValue(electron_1.ipcRenderer.sendSync("REMOTE_BROWSER_GET_BUILTIN",contextId,e,getCurrentStack()))}function getCurrentWindow(){return metaToValue(electron_1.ipcRenderer.sendSync("REMOTE_BROWSER_GET_CURRENT_WINDOW",contextId,getCurrentStack()))}function getCurrentWebContents(){return metaToValue(electron_1.ipcRenderer.sendSync("REMOTE_BROWSER_GET_CURRENT_WEB_CONTENTS",contextId,getCurrentStack()))}function getGlobal(e){return metaToValue(electron_1.ipcRenderer.sendSync("REMOTE_BROWSER_GET_GLOBAL",contextId,e,getCurrentStack()))}function createFunctionWithReturnValue(e){let t=()=>e;return isReturnValue.add(t),t}handleMessage("REMOTE_RENDERER_CALLBACK",(e,t)=>{callbacksRegistry.apply(e,metaToValue(t))}),handleMessage("REMOTE_RENDERER_RELEASE_CALLBACK",e=>{callbacksRegistry.remove(e)}),exports.require=e=>metaToValue(electron_1.ipcRenderer.sendSync("REMOTE_BROWSER_REQUIRE",contextId,e,getCurrentStack())),exports.getBuiltin=getBuiltin,exports.getCurrentWindow=getCurrentWindow,exports.getCurrentWebContents=getCurrentWebContents,exports.getGlobal=getGlobal,Object.defineProperty(exports,"process",{enumerable:!0,get:()=>exports.getGlobal("process")}),exports.createFunctionWithReturnValue=createFunctionWithReturnValue;let addBuiltinProperty=e=>{Object.defineProperty(exports,e,{enumerable:!0,get:()=>exports.getBuiltin(e)})};module_names_1.browserModuleNames.forEach(addBuiltinProperty);