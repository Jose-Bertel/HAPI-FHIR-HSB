"use strict";var converter=exports,Enum=require("./enum"),util=require("./util");function genValuePartial_fromObject(e,s,t,r){var a=!1;if(s.resolvedType)if(s.resolvedType instanceof Enum){e("switch(d%s){",r);for(var i=s.resolvedType.values,n=Object.keys(i),o=0;o<n.length;++o)i[n[o]]!==s.typeDefault||a||(e("default:")('if(typeof(d%s)==="number"){m%s=d%s;break}',r,r,r),s.repeated||e("break"),a=!0),e("case%j:",n[o])("case %i:",i[n[o]])("m%s=%j",r,i[n[o]])("break");e("}")}else e('if(typeof d%s!=="object")',r)("throw TypeError(%j)",s.fullName+": object expected")("m%s=types[%i].fromObject(d%s)",r,t,r);else{var l=!1;switch(s.type){case"double":case"float":e("m%s=Number(d%s)",r,r);break;case"uint32":case"fixed32":e("m%s=d%s>>>0",r,r);break;case"int32":case"sint32":case"sfixed32":e("m%s=d%s|0",r,r);break;case"uint64":l=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":e("if(util.Long)")("(m%s=util.Long.fromValue(d%s)).unsigned=%j",r,r,l)('else if(typeof d%s==="string")',r)("m%s=parseInt(d%s,10)",r,r)('else if(typeof d%s==="number")',r)("m%s=d%s",r,r)('else if(typeof d%s==="object")',r)("m%s=new util.LongBits(d%s.low>>>0,d%s.high>>>0).toNumber(%s)",r,r,r,l?"true":"");break;case"bytes":e('if(typeof d%s==="string")',r)("util.base64.decode(d%s,m%s=util.newBuffer(util.base64.length(d%s)),0)",r,r,r)("else if(d%s.length >= 0)",r)("m%s=d%s",r,r);break;case"string":e("m%s=String(d%s)",r,r);break;case"bool":e("m%s=Boolean(d%s)",r,r)}}return e}function genValuePartial_toObject(e,s,t,r){if(s.resolvedType)s.resolvedType instanceof Enum?e("d%s=o.enums===String?(types[%i].values[m%s]===undefined?m%s:types[%i].values[m%s]):m%s",r,t,r,r,t,r,r):e("d%s=types[%i].toObject(m%s,o)",r,t,r);else{var a=!1;switch(s.type){case"double":case"float":e("d%s=o.json&&!isFinite(m%s)?String(m%s):m%s",r,r,r,r);break;case"uint64":a=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":e('if(typeof m%s==="number")',r)("d%s=o.longs===String?String(m%s):m%s",r,r,r)("else")("d%s=o.longs===String?util.Long.prototype.toString.call(m%s):o.longs===Number?new util.LongBits(m%s.low>>>0,m%s.high>>>0).toNumber(%s):m%s",r,r,r,r,a?"true":"",r);break;case"bytes":e("d%s=o.bytes===String?util.base64.encode(m%s,0,m%s.length):o.bytes===Array?Array.prototype.slice.call(m%s):m%s",r,r,r,r,r);break;default:e("d%s=m%s",r,r)}}return e}converter.fromObject=function(e){var s=e.fieldsArray,t=util.codegen(["d"],e.name+"$fromObject")("if(d instanceof this.ctor)")("return d");if(!s.length)return t("return new this.ctor");t("var m=new this.ctor");for(var r=0;r<s.length;++r){var a=s[r].resolve(),i=util.safeProp(a.name);a.map?(t("if(d%s){",i)('if(typeof d%s!=="object")',i)("throw TypeError(%j)",a.fullName+": object expected")("m%s={}",i)("for(var ks=Object.keys(d%s),i=0;i<ks.length;++i){",i),genValuePartial_fromObject(t,a,r,i+"[ks[i]]")("}")("}")):a.repeated?(t("if(d%s){",i)("if(!Array.isArray(d%s))",i)("throw TypeError(%j)",a.fullName+": array expected")("m%s=[]",i)("for(var i=0;i<d%s.length;++i){",i),genValuePartial_fromObject(t,a,r,i+"[i]")("}")("}")):(a.resolvedType instanceof Enum||t("if(d%s!=null){",i),genValuePartial_fromObject(t,a,r,i),a.resolvedType instanceof Enum||t("}"))}return t("return m")},converter.toObject=function(e){var s=e.fieldsArray.slice().sort(util.compareFieldsById);if(!s.length)return util.codegen()("return {}");for(var t=util.codegen(["m","o"],e.name+"$toObject")("if(!o)")("o={}")("var d={}"),r=[],a=[],i=[],n=0;n<s.length;++n)s[n].partOf||(s[n].resolve().repeated?r:s[n].map?a:i).push(s[n]);if(r.length){for(t("if(o.arrays||o.defaults){"),n=0;n<r.length;++n)t("d%s=[]",util.safeProp(r[n].name));t("}")}if(a.length){for(t("if(o.objects||o.defaults){"),n=0;n<a.length;++n)t("d%s={}",util.safeProp(a[n].name));t("}")}if(i.length){for(t("if(o.defaults){"),n=0;n<i.length;++n){var o=i[n],l=util.safeProp(o.name);if(o.resolvedType instanceof Enum)t("d%s=o.enums===String?%j:%j",l,o.resolvedType.valuesById[o.typeDefault],o.typeDefault);else if(o.long)t("if(util.Long){")("var n=new util.Long(%i,%i,%j)",o.typeDefault.low,o.typeDefault.high,o.typeDefault.unsigned)("d%s=o.longs===String?n.toString():o.longs===Number?n.toNumber():n",l)("}else")("d%s=o.longs===String?%j:%i",l,o.typeDefault.toString(),o.typeDefault.toNumber());else if(o.bytes){var f="["+Array.prototype.slice.call(o.typeDefault).join(",")+"]";t("if(o.bytes===String)d%s=%j",l,String.fromCharCode.apply(String,o.typeDefault))("else{")("d%s=%s",l,f)("if(o.bytes!==Array)d%s=util.newBuffer(d%s)",l,l)("}")}else t("d%s=%j",l,o.typeDefault)}t("}")}var u=!1;for(n=0;n<s.length;++n){var o=s[n],d=e._fieldsArray.indexOf(o),l=util.safeProp(o.name);o.map?(u||(u=!0,t("var ks2")),t("if(m%s&&(ks2=Object.keys(m%s)).length){",l,l)("d%s={}",l)("for(var j=0;j<ks2.length;++j){"),genValuePartial_toObject(t,o,d,l+"[ks2[j]]")("}")):o.repeated?(t("if(m%s&&m%s.length){",l,l)("d%s=[]",l)("for(var j=0;j<m%s.length;++j){",l),genValuePartial_toObject(t,o,d,l+"[j]")("}")):(t("if(m%s!=null&&m.hasOwnProperty(%j)){",l,o.name),genValuePartial_toObject(t,o,d,l),o.partOf&&t("if(o.oneofs)")("d%s=%j",util.safeProp(o.partOf.name),o.name)),t("}")}return t("return d")};